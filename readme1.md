# JWT Auth + Cookies + SMTP (Конспект)

Простой конспект по коду сервера с авторизацией через JWT и cookies.

## Основные термины

- **SMTP** – протокол отправки писем (Simple Mail Transfer Protocol).
- **SMTP_PORT 587** – порт для отправки писем с шифрованием STARTTLS (обычный вариант для продакшена).
- **secure (в nodemailer)** – если `true`, подключение сразу через SSL (обычно порт 465). Для 587 оставляем `false`, так как STARTTLS включается автоматически.
- **JWT** – JSON Web Token, зашифрованные данные о пользователе.

## JWT

### jwt.sign(payload, secret, options)
Создаёт токен.
- **payload** – данные (например, `{ email }`).
- **secret** – секретный ключ для подписи.
- **options** – настройки (например, `expiresIn` – время жизни).

### jwt.verify(token, secret)
Проверяет токен, возвращает расшифрованные данные.

## Токены

- **Access Token** – короткоживущий (например, 15 мин). Нужен для каждого запроса к защищённым данным.
- **Refresh Token** – долгоживущий (например, 7 дней). Используется для выдачи нового access токена, когда старый истёк.

## Cookies

### res.cookie(name, value, options)
Создаёт cookie на клиенте.
- **httpOnly** – нельзя прочитать из JS, только сервером.
- **secure** – true только в продакшене (https).
- **sameSite** – ограничивает отправку cookie (Strict – только с вашего сайта).
- **maxAge** – время жизни в миллисекундах.

### res.clearCookie(name, options)
Удаляет cookie с теми же параметрами (path, secure и т.д.).

## Запросы

- **/api/register** – регистрация (создание пользователя, письмо с подтверждением).
- **/api/confirm** – подтверждение email через токен в ссылке.
- **/api/login** – вход (создание access и refresh токенов).
- **/api/refresh** – выдача нового access токена по refresh токену.
- **/api/logout** – удаляет оба токена (выход).
- **/api/me** – проверка текущего пользователя (достаём email из access токена).

## Для разработки и продакшена

- **secure**: false в dev, true в production (HTTPS).
- **SMTP_PORT**: 587 (обычно).
- **sameSite**: Strict (всегда).
- **maxAge**: выбираем сами (15 мин для access, 7 дней для refresh).